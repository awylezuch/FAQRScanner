<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR-Code Scanner (ZXing + Fallback)</title>
<style>
  :root { --accent:#0078d7; }
  html,body{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif}
  #scanner-container{position:relative;width:100vw;height:100vh;overflow:hidden;background:#000}
  #preview{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:0}
  .darken{position:absolute;inset:0;background:rgba(0,0,0,.35);z-index:1;pointer-events:none}
  .clear-window{position:absolute;top:30%;left:20%;width:60%;height:40%;border:3px solid var(--accent);border-radius:8px;background:transparent;z-index:2;pointer-events:none;box-shadow:0 0 0 9999px rgba(0,0,0,.25)}
  .scanline{position:absolute;left:20%;width:60%;height:2px;background:rgba(0,120,215,.9);border-radius:1px;animation:scanAnim 2s linear infinite;z-index:3;pointer-events:none}
  @keyframes scanAnim{0%{top:30%}50%{top:70%}100%{top:30%}}
  .controls{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:10px;z-index:9999;align-items:center;flex-wrap:wrap;justify-content:center;max-width:92vw}
  button,select{appearance:none;border:none;border-radius:8px;padding:12px 16px;font-size:16px;cursor:pointer}
  button{background:var(--accent);color:#fff}
  button.secondary{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#fff}
  select{background:rgba(0,0,0,.6);border:1px solid #777;color:#fff;min-width:220px}
  #status{position:absolute;left:12px;right:12px;bottom:80px;z-index:9999;font-size:14px;line-height:1.25;color:#eee;text-shadow:0 1px 2px rgba(0,0,0,.8);max-height:25vh;overflow:auto;padding:6px 8px;background:rgba(0,0,0,.35);border-radius:6px}
  #tapToStart{position:absolute;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:10000;gap:14px;text-align:center;padding:24px}
  #tapToStart button{font-size:18px;padding:14px 20px}
</style>
</head>
<body>
  <div id="scanner-container">
    <video id="preview" autoplay playsinline muted></video>

    <div class="darken"></div>
    <div class="clear-window" aria-hidden="true"></div>
    <div class="scanline" aria-hidden="true"></div>

    <div id="status">Initialisiere…</div>

    <div class="controls">
      <select id="cameraSelect" title="Kamera wählen"></select>
      <button id="switchCamera" class="secondary" type="button">Kamera wechseln</button>
      <button id="rescan" class="secondary" type="button" style="display:none;">Nochmal scannen</button>
    </div>

    <div id="tapToStart">
      <div>Zum Starten des Scanners tippen/klicken</div>
      <button id="startNow" type="button">Scanner starten</button>
    </div>
  </div>

  <!-- ZXing & jsQR -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
    const videoEl      = document.getElementById('preview');
    const statusEl     = document.getElementById('status');
    const cameraSelect = document.getElementById('cameraSelect');
    const switchBtn    = document.getElementById('switchCamera');
    const rescanBtn    = document.getElementById('rescan');
    const tapOverlay   = document.getElementById('tapToStart');
    const startNowBtn  = document.getElementById('startNow');

    // Canvas für Fallback
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // ZXing mit Hints
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    const reader = new ZXing.BrowserMultiFormatReader(hints);

    let devices  = [];
    let facing   = 'environment'; // bevorzugt Rückkamera
    let scanning = false;
    let fallbackActive = false;
    let lastDetectTs = 0;

    function log(msg){ console.log(msg); statusEl.textContent = typeof msg==='string'? msg : JSON.stringify(msg); }

    function stopTracks(){
      const s = videoEl.srcObject;
      if (s && s.getTracks){ s.getTracks().forEach(t=>t.stop()); }
      videoEl.srcObject = null;
    }

    async function listCameras(){
      try{
        devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId || '';
          opt.textContent = d.label || `Kamera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        if (!devices.length) log('Keine Kamera gefunden.');
      }catch(e){ log(`Geräteliste-Fehler: ${e.name} – ${e.message}`); }
    }

    function getScanRect(video) {
      // nutzt dieselben Prozente wie die CSS-Box (60% Breite, 40% Höhe; zentriert)
      const vw = video.videoWidth  || 1280;
      const vh = video.videoHeight || 720;
      const sw = Math.floor(vw * 0.60);
      const sh = Math.floor(vh * 0.40);
      const sx = Math.floor((vw - sw) / 2);
      const sy = Math.floor((vh - sh) / 2);
      return { sx, sy, sw, sh };
    }

    async function startZXingWithConstraints(prefFacing){
      const common = {
        width:  { ideal: 1920 },
        height: { ideal: 1080 },
        advanced: [{ focusMode: "continuous" }]
      };

      const tries = [
        { video: { ...common, facingMode: { exact: prefFacing } }, audio:false },
        { video: { ...common, facingMode: { ideal: prefFacing } }, audio:false },
        { video: { ...common, facingMode: { ideal: (prefFacing==='environment'?'user':'environment') } }, audio:false },
        { video: { ...common }, audio:false }
      ];

      for (const constraints of tries){
        const ok = await tryStart(constraints);
        if (ok) return true;
      }
      return false;
    }

    async function tryStart(constraints){
      try{
        stopTracks();

        // Sichtbares Video
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = stream;
        await videoEl.play().catch(()=>{});

        // ZXing kontinuierlich
        reader.reset();
        reader.decodeFromConstraints(
          { video: constraints.video, audio:false },
          'preview',
          (result, err) => {
            if (!scanning) return;
            if (result){
              lastDetectTs = Date.now();
              onDecode(result.text);
            }
            // Fehler während des kontinuierlichen Scans ignorieren (kommen häufig)
          }
        );

        await listCameras();
        scanning = true;
        fallbackActive = false;
        lastDetectTs = Date.now();
        log('Scanner läuft (ZXing)…');

        // Fallback nach 4 Sekunden ohne Treffer aktivieren
        setTimeout(()=> {
          if (scanning && Date.now() - lastDetectTs > 3500 && !fallbackActive) {
            log('Kein Treffer mit ZXing – Fallback aktiviert (jsQR im Fenster)…');
            startFallbackLoop();
          }
        }, 4000);

        return true;
      }catch(e){
        log(`Start-Fehler: ${e.name} – ${e.message}`);
        stopTracks();
        reader.reset();
        return false;
      }
    }

    function startFallbackLoop(){
      fallbackActive = true;
      const loop = () => {
        if (!scanning || !fallbackActive) return;

        const vw = videoEl.videoWidth, vh = videoEl.videoHeight;
        if (vw && vh){
          const { sx, sy, sw, sh } = getScanRect(videoEl);
          canvas.width = sw; canvas.height = sh;
          try{
            ctx.drawImage(videoEl, sx, sy, sw, sh, 0, 0, sw, sh);
            const imageData = ctx.getImageData(0, 0, sw, sh);
            const code = jsQR(imageData.data, sw, sh, { inversionAttempts: "attemptBoth" });
            if (code && code.data){
              onDecode(code.data);
              return;
            }
          }catch(e){
            // Zeichnen kann bei sehr altem Gerät mal fehlschlagen – ignorieren und weiter
          }
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }

    function onDecode(text){
      if (!scanning) return;
      scanning = false;
      fallbackActive = false;
      rescanBtn.style.display = 'inline-block';
      log(`QR erkannt: ${text}`);

      // Dein Parsing / Weiterleitung
      if (text && text.startsWith('$')){
        const m = text.match(/\$(FA.*?)\$/);
        if (m && m[1]){
          const extracted = m[1];
          const bcLink = `https://dein-bc-link.com/?id=${extracted}`;
          window.location.href = bcLink;
        }
      }
    }

    async function ensurePermission(){
      try{
        log('Berechtigung anfordern…');
        const tmp = await navig
