<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>QR-Code Scanner</title>
<style>
 body, html {
   margin: 0;
   padding: 0;
   overflow: hidden;
   font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
   background: #000;
 }
 #scanner-container {
   position: relative;
   width: 100vw;
   height: 100vh;
   overflow: hidden;
 }
 
 /* Video im Hintergrund */
 video {
   width: 100%;
   height: 100%;
   object-fit: cover;
   position: absolute;
   top: 0; left: 0;
   z-index: 0;
 }

 /* Abdunkelung außenrum */
 .darken {
   position: absolute;
   top: 0; left: 0;
   width: 100%; height: 100%;
   background: rgba(0,0,0,0.5);
   z-index: 1;
 }

 /* Klares Scan-Fenster */
 .clear-window {
   position: absolute;
   top: 30%; left: 20%;
   width: 60%; height: 40%;
   border: 3px solid #0078D7;
   border-radius: 6px;
   background: transparent;
   z-index: 2;
 }

 /* Scanlinie */
 .scanline {
   position: absolute;
   left: 20%;
   width: 60%;
   height: 2px;
   background: rgba(0,120,215,0.9);
   border-radius: 1px;
   animation: scanAnim 2s linear infinite;
   z-index: 3;
 }
 @keyframes scanAnim {
   0%   { top: 30%; }
   50%  { top: 70%; }
   100% { top: 30%; }
 }

 /* Buttons */
 .controls {
   position: absolute;
   bottom: 20px;
   left: 50%;
   transform: translateX(-50%);
   display: flex;
   gap: 12px;
   z-index: 9999; /* Immer ganz vorne */
 }
 button {
   padding: 15px 25px;
   font-size: 18px;
   border: none;
   border-radius: 6px;
   background: #0078D7;
   color: white;
   cursor: pointer;
   transition: background 0.2s;
 }
 button:hover {
   background-color: #005a9e;
 }
 button:disabled {
   background-color: #c7c7c7;
   cursor: default;
 }
</style>
</head>
<body>
<div id="scanner-container">
  <video id="preview" autoplay playsinline></video>
  <div class="darken"></div>
  <div class="clear-window"></div>
  <div class="scanline"></div>

  <div class="controls">
    <button id="switchCamera">Kamera wechseln</button>
    <button id="rescan" style="display:none;">Nochmal scannen</button>
  </div>
  <canvas id="canvas" hidden></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
 const video = document.getElementById("preview");
 const canvas = document.getElementById("canvas");
 const context = canvas.getContext("2d");
 const switchBtn = document.getElementById("switchCamera");
 const rescanBtn = document.getElementById("rescan");
 let currentStream = null;
 let useFrontCamera = true;
 let scanning = true;

 async function startCamera() {
   if (currentStream) {
     currentStream.getTracks().forEach(track => track.stop());
   }
   const constraints = { video: { facingMode: useFrontCamera ? "user" : "environment" } };
   try {
     currentStream = await navigator.mediaDevices.getUserMedia(constraints);
     video.srcObject = currentStream;
     video.onloadedmetadata = () => {
       scanning = true;
       requestAnimationFrame(scanFrame);
     };
   } catch (err) {
     console.error("Kamera-Fehler:", err);
   }
 }

 function stopCamera() {
   if (currentStream) currentStream.getTracks().forEach(track => track.stop());
 }

 function scanFrame() {
   if (!scanning) return;
   if (video.readyState === video.HAVE_ENOUGH_DATA) {
     canvas.width = video.videoWidth;
     canvas.height = video.videoHeight;
     context.drawImage(video, 0, 0, canvas.width, canvas.height);

     // Scanfenster (zentral 60% Breite, 40% Höhe)
     const scanWidth = canvas.width * 0.6;
     const scanHeight = canvas.height * 0.4;
     const scanX = (canvas.width - scanWidth) / 2;
     const scanY = (canvas.height - scanHeight) / 2;
     const imageData = context.getImageData(scanX, scanY, scanWidth, scanHeight);

     const code = jsQR(imageData.data, scanWidth, scanHeight);
     if (code && code.data.startsWith("$")) {
       scanning = false;
       stopCamera();
       rescanBtn.style.display = "inline-block";
       const qrString = code.data;
       const match = qrString.match(/\$(FA.*?)\$/);
       if (match && match[1]) {
         const extractedValue = match[1];
         console.log("Extrahierter Wert:", extractedValue);
         const bcLink = `https://dein-bc-link.com/?id=${extractedValue}`;
         window.location.href = bcLink;
       } else {
         console.log("QR-Code entspricht nicht dem FA-Format, wird ignoriert.");
       }
       return;
     }
   }
   requestAnimationFrame(scanFrame);
 }

 switchBtn.addEventListener("click", () => {
   useFrontCamera = !useFrontCamera;
   startCamera();
 });
 rescanBtn.addEventListener("click", () => {
   rescanBtn.style.display = "none";
   startCamera();
 });

 document.addEventListener('visibilitychange', () => {
   if (document.visibilityState === 'visible' && !scanning) {
     rescanBtn.style.display = "inline-block";
   }
 });

 startCamera();
</script>
</body>
</html>
