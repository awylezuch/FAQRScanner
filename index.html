<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>QR-Code Scanner (ZXing)</title>
<style>
 body, html {
   margin: 0;
   padding: 0;
   overflow: hidden;
   font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
   background: #000;
 }
 #scanner-container {
   position: relative;
   width: 100vw;
   height: 100vh;
   overflow: hidden;
 }
 
 /* Video im Hintergrund */
 video {
   width: 100%;
   height: 100%;
   object-fit: cover;
   position: absolute;
   top: 0; left: 0;
   z-index: 0;
 }

 /* Abdunkelung außenrum */
 .darken {
   position: absolute;
   top: 0; left: 0;
   width: 100%; height: 100%;
   background: rgba(0,0,0,0.5);
   z-index: 1;
 }

 /* Klares Scan-Fenster (Loch) */
 .clear-window {
   position: absolute;
   top: 30%; left: 20%;
   width: 60%; height: 40%;
   border: 3px solid #0078D7;
   border-radius: 6px;
   background: transparent;
   z-index: 2;
 }

 /* Scanlinie */
 .scanline {
   position: absolute;
   left: 20%;
   width: 60%;
   height: 2px;
   background: rgba(0,120,215,0.9);
   border-radius: 1px;
   animation: scanAnim 2s linear infinite;
   z-index: 3;
 }
 @keyframes scanAnim {
   0%   { top: 30%; }
   50%  { top: 70%; }
   100% { top: 30%; }
 }

 /* Buttons */
 .controls {
   position: absolute;
   bottom: 20px;
   left: 50%;
   transform: translateX(-50%);
   display: flex;
   gap: 12px;
   z-index: 9999; /* Ganz vorne */
 }
 button {
   padding: 15px 25px;
   font-size: 18px;
   border: none;
   border-radius: 6px;
   background: #0078D7;
   color: white;
   cursor: pointer;
   transition: background 0.2s;
 }
 button:hover {
   background-color: #005a9e;
 }
 button:disabled {
   background-color: #c7c7c7;
   cursor: default;
 }
</style>
</head>
<body>
<div id="scanner-container">
  <!-- wichtig: muted, sonst blocken manche Browser -->
  <video id="preview" autoplay playsinline muted></video>
  <div class="darken"></div>
  <div class="clear-window"></div>
  <div class="scanline"></div>

  <div class="controls">
    <button id="switchCamera">Kamera wechseln</button>
    <button id="rescan" style="display:none;">Nochmal scannen</button>
  </div>
</div>

<!-- ZXing Library -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
 const switchBtn = document.getElementById("switchCamera");
 const rescanBtn = document.getElementById("rescan");

 const codeReader = new ZXing.BrowserQRCodeReader();
 let selectedDeviceId = null;
 let devices = [];
 let useFront = true;

 async function startCamera(useFrontCam = true) {
   try {
     // Kameras abrufen
     devices = await ZXing.BrowserQRCodeReader.listVideoInputDevices();
     if (devices.length === 0) {
       console.error("Keine Kamera gefunden");
       return;
     }

     // Front oder Back wählen
     if (useFrontCam) {
       selectedDeviceId = devices.find(d => d.label.toLowerCase().includes("front"))?.deviceId || devices[0].deviceId;
     } else {
       selectedDeviceId = devices.find(d => d.label.toLowerCase().includes("back"))?.deviceId || devices[0].deviceId;
     }

     // Reset vorheriger Stream
     codeReader.reset();

     // Scanner starten → wichtig: "preview" als String!
     codeReader.decodeFromVideoDevice(selectedDeviceId, 'preview', (result, err) => {
       if (result) {
         console.log("QR erkannt:", result.text);
         rescanBtn.style.display = "inline-block";

         // Beispiel-Parsing wie bei dir
         if (result.text.startsWith("$")) {
           const match = result.text.match(/\$(FA.*?)\$/);
           if (match && match[1]) {
             const extractedValue = match[1];
             const bcLink = `https://dein-bc-link.com/?id=${extractedValue}`;
             window.location.href = bcLink;
           }
         }
       }
     });
   } catch (e) {
     console.error("Fehler beim Start:", e);
   }
 }

 // Buttons
 switchBtn.addEventListener("click", () => {
   useFront = !useFront;
   startCamera(useFront);
 });
 rescanBtn.addEventListener("click", () => {
   rescanBtn.style.display = "none";
   startCamera(useFront);
 });

 // Start beim Laden
 startCamera(true);
</script>
</body>
</html>
