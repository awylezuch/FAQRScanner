<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR‑Code Scanner (ZXing, robust)</title>
<style>
  :root {
    --accent: #0078d7;
  }
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    font-family: system-ui, "Segoe UI", Roboto, Arial, sans-serif;
    background: #000;
    color: #fff;
  }
  #scanner-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: #000;
  }

  /* Video sichtbar halten */
  #preview {
    position: absolute;
    inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    background: #000;
    z-index: 0;
  }

  /* Außen leicht abdunkeln */
  .darken {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 1;
    pointer-events: none;
  }

  /* Klarer Scan-Rahmen („Loch“ bleibt scharf) */
  .clear-window {
    position: absolute;
    top: 30%; left: 20%;
    width: 60%; height: 40%;
    border: 3px solid var(--accent);
    border-radius: 8px;
    background: transparent;
    z-index: 2;
    pointer-events: none;
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.25); /* dunkelt außen zusätzlich ab, Loch bleibt klar */
  }

  /* Scanlinie */
  .scanline {
    position: absolute;
    left: 20%;
    width: 60%;
    height: 2px;
    background: rgba(0,120,215,0.9);
    border-radius: 1px;
    animation: scanAnim 2s linear infinite;
    z-index: 3;
    pointer-events: none;
  }
  @keyframes scanAnim {
    0%   { top: 30%; }
    50%  { top: 70%; }
    100% { top: 30%; }
  }

  /* Controls + Status */
  .controls {
    position: absolute;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 9999;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 92vw;
  }
  button, select {
    appearance: none;
    border: none;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 16px;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
  }
  select {
    background: rgba(0,0,0,0.6);
    border: 1px solid #777;
    color: #fff;
    min-width: 220px;
  }
  button.secondary {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.25);
  }
  #status {
    position: absolute;
    left: 12px; right: 12px;
    bottom: 80px;
    z-index: 9999;
    font-size: 14px;
    line-height: 1.25;
    color: #eee;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    max-height: 25vh; overflow: auto;
    padding: 6px 8px;
    background: rgba(0,0,0,0.35);
    border-radius: 6px;
  }

  /* Start-Overlay (falls Autostart geblockt wird) */
  #tapToStart {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.65);
    color: #fff;
    display: none; /* wird nur gezeigt, wenn Autostart fehlschlägt */
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 10000;
    gap: 14px;
    text-align: center;
    padding: 24px;
  }
  #tapToStart button {
    font-size: 18px;
    padding: 14px 20px;
  }
</style>
</head>
<body>
  <div id="scanner-container">
    <!-- wichtig: muted + playsinline -->
    <video id="preview" autoplay playsinline muted></video>

    <div class="darken"></div>
    <div class="clear-window" aria-hidden="true"></div>
    <div class="scanline" aria-hidden="true"></div>

    <div id="status">Initialisiere…</div>

    <div class="controls">
      <select id="cameraSelect" title="Kamera wählen"></select>
      <button id="switchCamera" class="secondary" type="button">Kamera wechseln</button>
      <button id="rescan" class="secondary" type="button" style="display:none;">Nochmal scannen</button>
    </div>

    <!-- Fallback-Overlay, falls Autostart blockiert -->
    <div id="tapToStart">
      <div>Zum Starten des Scanners tippen/klicken</div>
      <button id="startNow" type="button">Scanner starten</button>
    </div>
  </div>

  <!-- ZXing Library -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const videoEl      = document.getElementById('preview');
    const statusEl     = document.getElementById('status');
    const cameraSelect = document.getElementById('cameraSelect');
    const switchBtn    = document.getElementById('switchCamera');
    const rescanBtn    = document.getElementById('rescan');
    const tapOverlay   = document.getElementById('tapToStart');
    const startNowBtn  = document.getElementById('startNow');

    const reader = new ZXing.BrowserQRCodeReader();
    let devices  = [];
    let currentDeviceId = null;

    function log(msg) {
      console.log(msg);
      statusEl.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg);
    }

    async function ensurePermissionPrompt() {
      // 1) Erzwinge eine Permission-Abfrage, falls noch keine erteilt wurde.
      try {
        log('Berechtigung anfordern…');
        const tmpStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        // sofort wieder stoppen – wir wollten nur die Abfrage
        tmpStream.getTracks().forEach(t => t.stop());
        log('Berechtigung OK.');
        return true;
      } catch (e) {
        log(`getUserMedia-Fehler: ${e.name} – ${e.message}`);
        return false;
      }
    }

    async function listCameras() {
      try {
        devices = await ZXing.BrowserQRCodeReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';
        devices.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Kamera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        log(devices.length ? `Gefundene Kameras: ${devices.length}` : 'Keine Kamera gefunden.');
      } catch (e) {
        log(`Geräteliste-Fehler: ${e.name} – ${e.message}`);
      }
    }

    async function startWithDevice(deviceId) {
      try {
        // a) Eigenen Stream sichtbar machen
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId } },
          audio: false
        });
        videoEl.srcObject = stream;
        await videoEl.play();

        // b) ZXing starten (nimmt dasselbe <video> per ID)
        reader.reset();
        reader.decodeFromVideoDevice(deviceId, 'preview', (result, err) => {
          if (result) {
            log(`QR erkannt: ${result.text}`);
            rescanBtn.style.display = 'inline-block';

            // Dein Parsing:
            const txt = result.text || '';
            if (txt.startsWith('$')) {
              const match = txt.match(/\$(FA.*?)\$/);
              if (match && match[1]) {
                const extracted = match[1];
                const bcLink = `https://dein-bc-link.com/?id=${extracted}`;
                window.location.href = bcLink;
              }
            }
          } else if (err) {
            // ZXing liefert während des Scans viele „Fehler“ (kein Code im Frame) – nicht laut loggen
          }
        });

        currentDeviceId = deviceId;
        // Auswahl synchronisieren
        if ([...cameraSelect.options].some(o => o.value === deviceId)) {
          cameraSelect.value = deviceId;
        }
        log('Scanner läuft.');
        return true;
      } catch (e) {
        log(`Start-Fehler: ${e.name} – ${e.message}`);
        return false;
      }
    }

    async function autoStart() {
      // Autostart-Sequenz:
      // Schritt 1: Permission prompt sicherstellen
      const ok = await ensurePermissionPrompt();
      if (!ok) {
        // Browser blockt Autostart → Overlay mit Start-Knopf zeigen
        tapOverlay.style.display = 'flex';
        return;
      }

      // Schritt 2: Kameras listen (mit Labels)
      await listCameras();
      if (!devices.length) {
        tapOverlay.style.display = 'flex';
        return;
      }

      // Schritt 3: sinnvolle Standardkamera wählen (Back bevorzugen)
      const back = devices.find(d => /back|rear|environment/i.test(d.label));
      const fallback = devices[0];
      const deviceId = (back && back.deviceId) || fallback.deviceId;

      // Schritt 4: starten
      const started = await startWithDevice(deviceId);
      if (!started) {
        tapOverlay.style.display = 'flex';
      }
    }

    // Kamera umschalten (Front/Back Heuristik)
    switchBtn.addEventListener('click', async () => {
      if (!devices.length) await listCameras();
      if (!devices.length) return;

      // Versuch, zwischen Back und Front zu togglen
      const isBack = /back|rear|environment/i.test(
        (devices.find(d => d.deviceId === currentDeviceId)?.label || '')
      );
      const target = devices.find(d =>
        isBack ? /front|user/i.test(d.label) : /back|rear|environment/i.test(d.label)
      ) || devices.find(d => d.deviceId !== currentDeviceId) || devices[0];

      await startWithDevice(target.deviceId);
    });

    // Auswahl per Dropdown explizit starten
    cameraSelect.addEventListener('change', async (e) => {
      const id = e.target.value;
      if (id) await startWithDevice(id);
    });

    rescanBtn.addEventListener('click', () => {
      rescanBtn.style.display = 'none';
      if (currentDeviceId) startWithDevice(currentDeviceId);
    });

    // Fallback: manueller Start wenn Autostart blockiert
    startNowBtn.addEventListener('click', async () => {
      tapOverlay.style.display = 'none';
      await autoStart();
    });

    // Seite geladen → Autostart versuchen
    window.addEventListener('load', autoStart);

    // Zusätzliche Sicherheitsnetze
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && currentDeviceId) {
        // Sicherstellen, dass das Video spielt
        if (videoEl.paused) videoEl.play().catch(()=>{});
      }
    });
  </script>
</body>
</html>
