<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR-Scanner (Front, stabil)</title>
<style>
  :root { --accent:#0078d7; }
  html,body{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
  #wrap{position:relative;width:100vw;height:100vh;background:#000}
  video{
    position:fixed; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    background:#111;
    transform:none !important; -webkit-transform:none !important;
    will-change:transform; backface-visibility:hidden; -webkit-backface-visibility:hidden;
  }
  .window{position:absolute;top:30%;left:20%;width:60%;height:40%;border:3px solid var(--accent);border-radius:8px;z-index:2;pointer-events:none}
  .scanline{position:absolute;left:20%;width:60%;height:2px;background:rgba(0,120,215,.95);border-radius:1px;animation:scanAnim 2s linear infinite;z-index:3;pointer-events:none}
  @keyframes scanAnim{0%{top:30%}50%{top:70%}100%{top:30%}}
  .controls{position:fixed; top:calc(env(safe-area-inset-top, 0px) + 10px); left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:10000}
  button{appearance:none;border:none;border-radius:8px;padding:10px 14px;font-size:15px;cursor:pointer;background:var(--accent);color:#fff}
  button.secondary{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
  #status{position:fixed;left:12px;right:12px;top:calc(env(safe-area-inset-top, 0px) + 56px);z-index:10000;font-size:13px;line-height:1.25;color:#eee;text-shadow:0 1px 2px rgba(0,0,0,.8);max-height:25vh;overflow:auto;padding:6px 8px;background:rgba(0,0,0,.35);border-radius:6px}
</style>
</head>
<body>
  <div id="wrap">
    <video id="vid" autoplay playsinline muted webkit-playsinline></video>

    <div class="window" aria-hidden="true"></div>
    <div class="scanline" aria-hidden="true"></div>

    <div id="status">Initialisiere…</div>

    <div class="controls">
      <button id="switch" class="secondary" type="button">Kamera wechseln</button>
      <button id="rescan" class="secondary" type="button" style="display:none;">Nochmal scannen</button>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
    const vid  = document.getElementById('vid');
    const logEl= document.getElementById('status');
    const btnS = document.getElementById('switch');
    const btnR = document.getElementById('rescan');

    const FALLBACK_DELAY_MS = 8000;

    let devices=[], frontId=null, backId=null, currentId=null;
    let stream=null, scanning=false, fallback=false, fallbackTimer=null, switching=false, lastHit=0;

    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    const reader = new ZXing.BrowserMultiFormatReader(hints);

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const log = (m)=>{ console.log(m); logEl.textContent = (typeof m==='string')? m : JSON.stringify(m); };

    function stop(){
      try{ reader.reset(); }catch(e){}
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      vid.srcObject=null; currentId=null; scanning=false; fallback=false;
      if (fallbackTimer){ clearTimeout(fallbackTimer); fallbackTimer=null; }
    }

    async function ensurePermission(){
      try{
        log('Berechtigung anfordern…');
        const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        tmp.getTracks().forEach(t=>t.stop());
        log('Berechtigung OK.');
        return true;
      }catch(e){ log(`getUserMedia-Fehler: ${e.name} – ${e.message}`); return false; }
    }

    async function enumerate(){
      devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
      const find = (rx)=> devices.find(d => rx.test((d.label||'').toLowerCase()))?.deviceId || null;
      frontId = find(/front|user/); backId = find(/back|rear|environment/);
      if (!frontId && devices[0]) frontId=devices[0].deviceId;
      if (!backId  && devices[1]) backId =devices[1].deviceId || frontId;
      log(`Kameras: ${devices.length} | Front=${!!frontId} Back=${!!backId}`);
    }

    function scanRect(){
      const vw = vid.videoWidth  || 1280, vh = vid.videoHeight || 720;
      const sw = Math.floor(vw*0.60), sh = Math.floor(vh*0.40);
      const sx = Math.floor((vw-sw)/2), sy = Math.floor((vh-sh)/2);
      return {sx,sy,sw,sh};
    }

    function extractValue(txt){
      let m = txt.match(/\$(FA[^$]+)\$/); if (m && m[1]) return m[1];
      m = txt.match(/^(FA[^$]+)/);        if (m && m[1]) return m[1];
      return txt;
    }

    function goBC(extracted){
      const url = "https://bcprod01.schwegler.de/BCProd/?page=99000831&company=Schwegler%20Werkzeugfabrik&dc=0&filter=%27No.%27%20IS%20%27"
        + encodeURIComponent(extracted) + "%27";
      window.location.href = url;
    }

    function onDecode(extracted){
      if (!scanning) return;
      scanning=false; fallback=false;
      if (fallbackTimer){ clearTimeout(fallbackTimer); fallbackTimer=null; }
      btnR.style.display='inline-block';
      log(`QR erkannt: ${extracted}`);
      goBC(extracted);
    }

    async function startId(id, attempt=0){
      if (switching) return; switching=true;
      try{
        stop();
        // Minimal-konstraints (keine großen Auflösungswünsche!)
        const c = { video:{ deviceId:{ exact:id } }, audio:false };
        stream = await navigator.mediaDevices.getUserMedia(c);
        vid.srcObject = stream;

        // Auf echte Metadaten warten und dann play()
        await new Promise(res=>{ if(vid.readyState>=2) res(); else vid.onloadedmetadata=res; });
        await vid.play().catch(()=>{});

        // Front nicht spiegeln (Workaround gegen Renderbugs)
        vid.style.transform = 'none';

        // ZXing direkt vom Video lesen
        reader.reset();
        reader.decodeFromVideoElementContinuously(vid, (result, err)=>{
          if (!scanning) return;
          if (result && result.getText){
            lastHit=Date.now();
            onDecode(extractValue(result.getText()));
          }
        });

        currentId=id; scanning=true; fallback=false; lastHit=Date.now();
        log(`Scanner läuft – ${id===frontId?'Front':'Back'}`);

        // Fallback erst nach 8s
        if (fallbackTimer) clearTimeout(fallbackTimer);
        fallbackTimer = setTimeout(()=>{
          if (scanning && Date.now()-lastHit > 7500 && !fallback){
            log('Kein Treffer mit ZXing – Fallback aktiv (jsQR)…');
            startFallback();
          }
        }, FALLBACK_DELAY_MS);

      }catch(e){
        log(`Start-Fehler: ${e.name} – ${e.message}`);
        if (e.name==='NotReadableError' && attempt<3){
          await sleep(600);
          await startId(id, attempt+1);
        }
      }finally{ switching=false; }
    }

    function startFallback(){
      fallback=true;
      const loop=()=>{
        if (!scanning || !fallback) return;
        const vw=vid.videoWidth, vh=vid.videoHeight;
        if (vw && vh){
          const {sx,sy,sw,sh}=scanRect();
          canvas.width=sw; canvas.height=sh;
          try{
            ctx.drawImage(vid, sx,sy,sw,sh, 0,0,sw,sh);
            const img=ctx.getImageData(0,0,sw,sh);
            const code=jsQR(img.data, sw, sh, { inversionAttempts:"attemptBoth" });
            if (code && code.data){ onDecode(extractValue(code.data)); return; }
          }catch(_){}
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }

    async function autoStart(){
      const ok = await ensurePermission();
      if (!ok) return;
      await enumerate();
      const first = frontId || backId || (devices[0] && devices[0].deviceId);
      if (!first){ log('Keine Kamera verfügbar.'); return; }
      await startId(first);
    }

    // UI
    btnS.addEventListener('click', async ()=>{
      if (!devices.length) await enumerate();
      const target =
        (currentId===frontId && backId) ? backId :
        (currentId===backId  && frontId) ? frontId :
        (currentId!==frontId && frontId) ? frontId :
        backId || frontId || (devices[0] && devices[0].deviceId);
      btnR.style.display='none'; scanning=true; fallback=false;
      await startId(target);
    });

    btnR.addEventListener('click', async ()=>{
      btnR.style.display='none'; scanning=true; fallback=false;
      if (!currentId) await autoStart(); else await startId(currentId);
    });

    window.addEventListener('load', autoStart);
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState==='visible' && vid.srcObject && vid.paused){
        vid.play().catch(()=>{});
      }
    });
  </script>
</body>
</html>
