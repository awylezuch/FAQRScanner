<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QR-Code Scanner (ZXing, Auto + Fallback)</title>
<style>
  :root { --accent:#0078d7; }
  html,body{margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif}
  #scanner-container{position:relative;width:100vw;height:100vh;overflow:hidden;background:#000}
  #preview{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:0}
  .darken{position:absolute;inset:0;background:rgba(0,0,0,.4);z-index:1;pointer-events:none}
  .clear-window{position:absolute;top:30%;left:20%;width:60%;height:40%;border:3px solid var(--accent);border-radius:8px;background:transparent;z-index:2;pointer-events:none;box-shadow:0 0 0 9999px rgba(0,0,0,.25)}
  .scanline{position:absolute;left:20%;width:60%;height:2px;background:rgba(0,120,215,.9);border-radius:1px;animation:scanAnim 2s linear infinite;z-index:3;pointer-events:none}
  @keyframes scanAnim{0%{top:30%}50%{top:70%}100%{top:30%}}
  .controls{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:10px;z-index:9999;align-items:center;flex-wrap:wrap;justify-content:center;max-width:92vw}
  button,select{appearance:none;border:none;border-radius:8px;padding:12px 16px;font-size:16px;cursor:pointer}
  button{background:var(--accent);color:#fff}
  button.secondary{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);color:#fff}
  select{background:rgba(0,0,0,.6);border:1px solid #777;color:#fff;min-width:220px}
  #status{position:absolute;left:12px;right:12px;bottom:80px;z-index:9999;font-size:14px;line-height:1.25;color:#eee;text-shadow:0 1px 2px rgba(0,0,0,.8);max-height:25vh;overflow:auto;padding:6px 8px;background:rgba(0,0,0,.35);border-radius:6px}
  #tapToStart{position:absolute;inset:0;background:rgba(0,0,0,.65);color:#fff;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:10000;gap:14px;text-align:center;padding:24px}
  #tapToStart button{font-size:18px;padding:14px 20px}
</style>
</head>
<body>
  <div id="scanner-container">
    <!-- wichtig: muted + playsinline -->
    <video id="preview" autoplay playsinline muted></video>

    <div class="darken"></div>
    <div class="clear-window" aria-hidden="true"></div>
    <div class="scanline" aria-hidden="true"></div>

    <div id="status">Initialisiere…</div>

    <div class="controls">
      <select id="cameraSelect" title="Kamera wählen"></select>
      <button id="switchCamera" class="secondary" type="button">Kamera wechseln</button>
      <button id="rescan" class="secondary" type="button" style="display:none;">Nochmal scannen</button>
    </div>

    <div id="tapToStart">
      <div>Zum Starten des Scanners tippen/klicken</div>
      <button id="startNow" type="button">Scanner starten</button>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const videoEl      = document.getElementById('preview');
    const statusEl     = document.getElementById('status');
    const cameraSelect = document.getElementById('cameraSelect');
    const switchBtn    = document.getElementById('switchCamera');
    const rescanBtn    = document.getElementById('rescan');
    const tapOverlay   = document.getElementById('tapToStart');
    const startNowBtn  = document.getElementById('startNow');

    const reader = new ZXing.BrowserQRCodeReader();
    let devices  = [];
    let facing   = 'environment'; // 'environment' | 'user'
    let scanning = false;

    function log(msg){ console.log(msg); statusEl.textContent = typeof msg==='string'? msg : JSON.stringify(msg); }

    function stopTracks(){
      const s = videoEl.srcObject;
      if (s && s.getTracks){ s.getTracks().forEach(t=>t.stop()); }
      videoEl.srcObject = null;
    }

    async function listCameras(){
      try{
        devices = await ZXing.BrowserQRCodeReader.listVideoInputDevices();
        cameraSelect.innerHTML = '';
        devices.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId || '';
          opt.textContent = d.label || `Kamera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        log(devices.length ? `Gefundene Kameras: ${devices.length}` : 'Keine Kamera gefunden.');
      }catch(e){ log(`Geräteliste-Fehler: ${e.name} – ${e.message}`); }
    }

    async function startWithConstraints(prefFacing){
      // Versuch 1: exact facing
      let constraints = { video: { facingMode: { exact: prefFacing } }, audio:false };
      let ok = await tryStart(constraints);
      if (ok) return true;

      // Versuch 2: ideal facing
      constraints = { video: { facingMode: { ideal: prefFacing } }, audio:false };
      ok = await tryStart(constraints);
      if (ok) return true;

      // Versuch 3: andere Seite
      const other = prefFacing === 'environment' ? 'user' : 'environment';
      constraints = { video: { facingMode: { ideal: other } }, audio:false };
      ok = await tryStart(constraints);
      if (ok){ facing = other; return true; }

      // Versuch 4: generisch
      constraints = { video: true, audio:false };
      ok = await tryStart(constraints);
      return ok;
    }

    async function tryStart(constraints){
      try{
        stopTracks();
        // Sichtbares Video sicherstellen
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = stream;
        await videoEl.play().catch(()=>{});

        // ZXing über dieselben Constraints starten
        reader.reset();
        await reader.decodeFromConstraints(
          { video: constraints.video, audio:false },
          'preview',
          (result, err) => {
            if (result && scanning){
              log(`QR erkannt: ${result.text}`);
              rescanBtn.style.display = 'inline-block';
              scanning = false;

              const txt = result.text || '';
              if (txt.startsWith('$')){
                const m = txt.match(/\$(FA.*?)\$/);
                if (m && m[1]){
                  const extracted = m[1];
                  const bcLink = `https://dein-bc-link.com/?id=${extracted}`;
                  window.location.href = bcLink;
                }
              }
            }
          }
        );

        // Kameraliste (mit Labels) nach erfolgreichem Start laden
        await listCameras();
        // Versuche, Auswahl annähernd zu setzen
        const guess = devices.find(d => new RegExp(facing,'i').test(d.label || ''));
        if (guess && guess.deviceId){ cameraSelect.value = guess.deviceId; }

        scanning = true;
        log('Scanner läuft.');
        return true;
      }catch(e){
        log(`Start-Fehler: ${e.name} – ${e.message}`);
        stopTracks();
        reader.reset();
        return false;
      }
    }

    async function autoStart(){
      // 1) Einmalige Permission erzwingen (zeigt ggf. Prompt)
      try{
        log('Berechtigung anfordern…');
        const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        tmp.getTracks().forEach(t=>t.stop());
        log('Berechtigung OK.');
      }catch(e){
        log(`getUserMedia-Fehler: ${e.name} – ${e.message}`);
        // Wenn blockiert → Overlay anzeigen
        tapOverlay.style.display = 'flex';
        return;
      }

      // 2) Start mit bevorzugter Kamera
      const ok = await startWithConstraints(facing);
      if (!ok){
        // Browser verlangt Interaktion → Overlay zeigen
        tapOverlay.style.display = 'flex';
      }else{
        tapOverlay.style.display = 'none';
      }
    }

    // UI-Events
    startNowBtn.addEventListener('click', async ()=>{
      tapOverlay.style.display = 'none';
      await autoStart();
    });

    switchBtn.addEventListener('click', async ()=>{
      facing = (facing === 'environment') ? 'user' : 'environment';
      await startWithConstraints(facing);
    });

    cameraSelect.addEventListener('change', async (e)=>{
      const id = e.target.value;
      if (!id) return;
      // Wenn eine deviceId existiert, starte gezielt
      stopTracks();
      reader.reset();
      try{
        // Sichtbar machen
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact:id } }, audio:false });
        videoEl.srcObject = stream; await videoEl.play().catch(()=>{});
        // ZXing
        await reader.decodeFromVideoDevice(id, 'preview', (result, err)=>{
          if (result && scanning){
            log(`QR erkannt: ${result.text}`);
            rescanBtn.style.display = 'inline-block';
            scanning = false;
          }
        });
        log('Scanner läuft (gewählte Kamera).');
      }catch(err){
        log(`Start(gewählt)-Fehler: ${err.name} – ${err.message}`);
      }
    });

    rescanBtn.addEventListener('click', async ()=>{
      rescanBtn.style.display = 'none';
      scanning = true;
      await startWithConstraints(facing);
    });

    window.addEventListener('load', autoStart);
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible' && videoEl.srcObject && videoEl.paused){
        videoEl.play().catch(()=>{});
      }
    });
  </script>
</body>
</html>
